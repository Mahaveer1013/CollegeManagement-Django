{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block custom_css %}
<style>
.attendance_div_red{
    padding: 10px;
    background: #f44336;
    border: 3px solid white;
    text-align: center;
    color: #fff;
    border-radius: 30px;
    box-shadow: 1px 1px 1px grey;
    margin: 5px;
}
.attendance_div_green{
    padding: 10px;
    background: #4CAF50;
    border: 3px solid white;
    text-align: center;
    color: #fff;
    border-radius: 30px;
    box-shadow: 1px 1px 1px grey;
    margin: 5px;
}
</style>
{% endblock custom_css %}
{% block content %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{page_title}}</h3>
                    </div>

                    {% include "main_app/form_template.html" with messages=messages  form=form button_text="View Attendance"%}
                </div>
                <!-- /.card -->

            </div>
        </div>
    </div>
</section>
{% endblock content %}


{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
    document.getElementById("fetch_attendance").addEventListener("click", function () {
        var subject = document.getElementById("subject").value;
        var attendance = document.getElementById("attendance").value;
        document.getElementById("student_data").innerHTML = "";

        if (attendance.length < 1 || subject.length < 1) {
            document.getElementById("error_attendance").innerHTML = "Kindly Choose Both Subject and Attendance";
            document.getElementById("attendance_block").style.display = "none";
            document.getElementById("error_attendance").style.display = "block";
            return false;
        }

        fetch("{% url 'get_attendance' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() // Adjust this function to get CSRF token
            },
            body: JSON.stringify({
                subject: subject,
                attendance: attendance
            })
        })
        .then(response => response.json())
        .then(json_data => {
            if (json_data.length > 0) {
                let html = "";
                json_data.forEach(item => {
                    html += `<option value='${item.id}'>${item.attendance_date}</option>`;
                });
                document.getElementById("attendance_date").innerHTML = html;
                document.getElementById("error_attendance").style.display = "none";
                document.getElementById("error_attendance").innerHTML = "";
                document.getElementById("attendance_block").style.display = "block";
                document.getElementById("fetch_student_block").style.display = "block";
            } else {
                document.getElementById("error_attendance").innerHTML = "No Attendance Date Found For Specified Data";
                document.getElementById("error_attendance").style.display = "block";
                document.getElementById("attendance_date").innerHTML = "";
                document.getElementById("attendance_block").style.display = "none";
                document.getElementById("student_data").innerHTML = "";
            }
        })
        .catch(error => {
            alert("Error While Fetching Data");
            document.getElementById("error_attendance").innerHTML = "";
            document.getElementById("error_attendance").style.display = "block";
            document.getElementById("attendance_block").style.display = "none";
            document.getElementById("student_data").innerHTML = "";
        });
    });

    document.getElementById("fetch_student").addEventListener("click", function () {
        var attendance_date = document.getElementById("attendance_date").value;
        var attendance = document.getElementById("attendance").value;
        var subject = document.getElementById("subject").value;
        document.getElementById("student_data").innerHTML = "";

        if (attendance_date.length === 0) {
            alert("Please Choose A Date");
            document.getElementById("save_attendance").style.display = "none";
            return false;
        }

        fetch("{% url 'get_admin_attendance' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() // Adjust this function to get CSRF token
            },
            body: JSON.stringify({
                attendance_date_id: attendance_date,
                attendance: attendance,
                subject: subject
            })
        })
        .then(response => response.json())
        .then(json_data => {
            if (json_data.length < 1) {
                alert("No data to display");
            } else {
                let div_data = "<hr/><div class='form-group'></div><div class='form-group'> <label>Student Attendance</label><div class='row'>";

                json_data.forEach(item => {
                    if (item.status === 'True') {
                        div_data += `<div class='col-lg-3 attendance_div_green'><b>${item.name}</b><br/>Present</div>`;
                    } else {
                        div_data += `<div class='col-lg-3 attendance_div_red'><b>${item.name}</b><br/>Absent</div>`;
                    }
                });
                div_data += "</div></div>";
                document.getElementById("student_data").innerHTML = div_data;
            }
        })
        .catch(error => {
            alert("Error in fetching students");
        });
    });
});

// Example function to get CSRF token (customize based on your setup)
function getCsrfToken() {
    var csrftoken = null;
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
            csrftoken = cookie.substring('csrftoken='.length, cookie.length);
            break;
        }
    }
    return csrftoken;
}

</script>
{% endblock custom_js %}