{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}
{% block content %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                    </div>
                    <!-- /.card-header -->
                    <!-- form start -->
                    <div class="card-body">
                        <form id="selection-form">
                            {% csrf_token %}

                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" name="date" class="form-control" id="date">
                            </div>

                            <div class="form-group">
                                <label>Period</label>
                                <select name="period" class="form-control" id="period">
                                    <option value="">Select Period</option>
                                    {% for period in periods %}
                                    <option value="{{ period }}">Period {{ period }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <button type="button" id="fetch_students" class="btn btn-success">Fetch Students</button>
                        </form>

                        <form id="attendance-form" method="post" action="{% url 'submit_attendance' %}" onsubmit="collectCheckboxes()">
                            {% csrf_token %}
                            <div id="student_data" class="mt-4" style="overflow: auto;">
                                <!-- Students will be populated here with checkboxes -->
                            </div>

                        </form>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
        </div>
    </div>
</section>

{% endblock content %}

{% block custom_js %}
<script>document.getElementById('student_data').innerHTML = ''
    function collectCheckboxes() {
        const form = document.getElementById('attendance-form');
        if(form){
            const checkedInputs = form.querySelectorAll('input[type="checkbox"]:checked');
            const uncheckedInputs = form.querySelectorAll('input[type="checkbox"]:not(:checked)');

            const checkedValues = [];
            const uncheckedValues = [];
            checkedInputs.forEach(input => checkedValues.push(input.value));
            uncheckedInputs.forEach(input => uncheckedValues.push(input.value));

            document.getElementById('checked_students').value = checkedValues.join(',');
            document.getElementById('unchecked_students').value = uncheckedValues.join(',');
            console.log(document.getElementById('checked_students').value,' checked');
            console.log(document.getElementById('unchecked_students').value,' unchecked');
        }else{
            console.log('No form detected');
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('fetch_students').addEventListener('click', function () {
            var date = document.getElementById('date').value;
            var period = document.getElementById('period').value;
            var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            if (!date || !period) {
                alert("Please select both date and period.");
                return;
            }

            // Prepare the request data
            var formData = new URLSearchParams();
            formData.append('date', date);
            formData.append('period', period);

            // Send the request using fetch
            fetch("{% url 'fetch_students' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: formData.toString()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok.");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.students) {
                        var students = data.students;
                        console.log(students);
                        var studentDataHtml = `<h3>Students: (${data.class_name})</h3>`;

                        if (students.length > 0) {
                            studentDataHtml += `<input type='hidden' value='${data.date}' name='date' id='date' />`;
                            studentDataHtml += `<input type='hidden' value='${data.period}' name='period' id='period' />
                                                <input type="hidden" id="checked_students" name="checked_students" value="">
                                                <input type="hidden" id="unchecked_students" name="unchecked_students" value="">`;
                            students.forEach(student => {
                                studentDataHtml += `
                                <div class='col-lg-5'>
                                    <div class='form-check custom-control custom-checkbox' style="display: flex;align-items: center;justify-content: start;">
                                        <input type='checkbox' class='custom-control-input' checked='checked' name='student_data' value='${student.id}' id='checkbox${student.id}' onchange='collectCheckboxes()'>
                                        <label for='checkbox${student.id}'  style="display:flex;text-wrap:nowrap;padding:10px" class='custom-control-label'>${student.name} - (${student.roll_number}) - (${student.register_number})</label>
                                    </div>
                                </div>
                            `;
                            });
                            

                            studentDataHtml += `
                        </div>
                        <div class='form-group'>
                            <button id='save_attendance' class='btn btn-success' type='submit'>Save Attendance</button>
                            </div>
                            `;
                            // Add event listeners to checkboxes
                            // addCheckboxEventListeners();
                        } else {
                            studentDataHtml += "<h3>No students found.</h3>";
                        }

                    } else if (data.message) {
                        studentDataHtml += `<h3 style="width:100%; text-align:center;">${data.message}<h3>`;
                    }
                    document.getElementById('student_data').innerHTML = studentDataHtml;
                })
                .catch(error => {
                    console.error("Error fetching student data:", error);
                    alert("Error fetching student data.");
                });
        });
    });
</script>
<style>
    .custom-control-label::after{
        top: 14px;
        left: -12px;
    }
    .custom-control-label::before{
        position: absolute;
        top: 14px;
        left: -12px;
    }
</style>


{% endblock custom_js %}